<template>
  <lightning-card title="Shopping Cart" icon-name="standard:orders">
    <!-- Loading Spinner -->
    <template if:true={loading}>
      <div class="slds-p-around_medium slds-text-align_center">
        <lightning-spinner
          alternative-text="Loading cart..."
          size="medium"
        ></lightning-spinner>
      </div>
    </template>

    <!-- Empty Cart Message -->
    <template if:true={isCartEmpty}>
      <div class="slds-p-around_medium slds-text-align_center">
        <lightning-icon
          icon-name="standard:orders"
          size="large"
          class="slds-m-bottom_small"
        ></lightning-icon>
        <p class="slds-text-heading_medium">Your cart is empty</p>
        <p
          class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium"
        >
          Add some products to get started
        </p>
        <lightning-button
          variant="brand"
          label="Continue Shopping"
          onclick={handleContinueShopping}
        >
        </lightning-button>
      </div>
    </template>

    <!-- Cart Items -->
    <template if:true={hasItems}>
      <div class="slds-p-around_medium">
        <!-- Cart Items List -->
        <div class="cart-items">
          <template for:each={cartItems} for:item="item">
            <div key={item.Id} class="cart-item slds-card slds-m-bottom_small">
              <div class="slds-grid slds-gutters slds-p-around_medium">
                <!-- Product Image -->
                <div class="slds-col slds-size_1-of-6">
                  <template if:true={item.Product__r.Image_URL__c}>
                    <img
                      src={item.Product__r.Image_URL__c}
                      alt={item.Product__r.Name}
                      class="product-thumbnail"
                    />
                  </template>
                  <template if:false={item.Product__r.Image_URL__c}>
                    <div class="product-thumbnail-placeholder">
                      <lightning-icon
                        icon-name="standard:product"
                        size="small"
                      ></lightning-icon>
                    </div>
                  </template>
                </div>

                <!-- Product Details -->
                <div class="slds-col slds-size_1-of-3">
                  <h3 class="slds-text-heading_small slds-m-bottom_x-small">
                    {item.Product__r.Name}
                  </h3>
                  <p class="slds-text-body_small slds-text-color_weak">
                    SKU: {item.Product__r.ProductCode}
                  </p>
                </div>

                <!-- Quantity -->
                <div class="slds-col slds-size_1-of-6">
                  <lightning-input
                    type="number"
                    label="Quantity"
                    value={item.Quantity__c}
                    min="1"
                    max={item.Product__r.Stock_Quantity__c}
                    onchange={handleQuantityChange}
                    data-item-id={item.Id}
                  >
                  </lightning-input>
                </div>

                <!-- Unit Price -->
                <div class="slds-col slds-size_1-of-6">
                  <p class="slds-text-body_small slds-text-color_weak">
                    Unit Price
                  </p>
                  <p class="slds-text-heading_small">
                    <lightning-formatted-number
                      value={item.Unit_Price__c}
                      format-style="currency"
                      currency-code="USD"
                    >
                    </lightning-formatted-number>
                  </p>
                </div>

                <!-- Line Total -->
                <div class="slds-col slds-size_1-of-6">
                  <p class="slds-text-body_small slds-text-color_weak">Total</p>
                  <p class="slds-text-heading_small">
                    <lightning-formatted-number
                      value={item.Line_Total__c}
                      format-style="currency"
                      currency-code="USD"
                    >
                    </lightning-formatted-number>
                  </p>
                </div>

                <!-- Remove Button -->
                <div class="slds-col slds-size_1-of-12">
                  <lightning-button-icon
                    icon-name="utility:delete"
                    variant="bare"
                    alternative-text="Remove item"
                    onclick={handleRemoveItem}
                    data-item-id={item.Id}
                  >
                  </lightning-button-icon>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- Cart Summary -->
        <div class="cart-summary slds-card slds-m-top_medium">
          <div class="slds-p-around_medium">
            <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
              <span class="slds-text-heading_medium">Cart Summary</span>
              <span class="slds-text-heading_medium">
                <lightning-formatted-number
                  value={cartSubtotal}
                  format-style="currency"
                  currency-code="USD"
                >
                </lightning-formatted-number>
              </span>
            </div>

            <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
              <span class="slds-text-body_regular"
                >Items: {cartTotalItems}</span
              >
              <span class="slds-text-body_regular"
                >Subtotal:
                <lightning-formatted-number
                  value={cartSubtotal}
                  format-style="currency"
                  currency-code="USD"
                >
                </lightning-formatted-number>
              </span>
            </div>

            <!-- Action Buttons -->
            <div class="slds-grid slds-grid_align-spread">
              <lightning-button
                variant="neutral"
                label="Continue Shopping"
                onclick={handleContinueShopping}
              >
              </lightning-button>

              <lightning-button
                variant="brand"
                label="Proceed to Checkout"
                onclick={handleCheckout}
              >
              </lightning-button>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Checkout Modal -->
    <template if:true={showCheckoutModal}>
      <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container slds-modal_large">
          <!-- Modal Header -->
          <header class="slds-modal__header">
            <h2 class="slds-text-heading_medium">Checkout</h2>
            <lightning-button-icon
              icon-name="utility:close"
              variant="bare"
              alternative-text="Close"
              onclick={handleCloseCheckoutModal}
            >
            </lightning-button-icon>
          </header>

          <!-- Modal Body -->
          <div class="slds-modal__content slds-p-around_medium">
            <!-- Order Summary -->
            <div class="slds-m-bottom_medium">
              <h3 class="slds-text-heading_small slds-m-bottom_small">Order Summary</h3>
              <ul class="slds-list_dotted slds-m-top_small">
                <li>Items: {cartTotalItems}</li>
                <li>
                  Subtotal:
                  <lightning-formatted-number
                    value={cartSubtotal}
                    format-style="currency"
                    currency-code="USD"
                  >
                  </lightning-formatted-number>
                </li>
              </ul>
            </div>

            <!-- Contact Information Form -->
            <div class="slds-m-bottom_medium">
              <h3 class="slds-text-heading_small slds-m-bottom_small">Contact Information</h3>
              <div class="slds-grid slds-gutters">
                <div class="slds-col slds-size_1-of-2">
                  <lightning-input
                    name="firstName"
                    label="First Name"
                    value={contactForm.firstName}
                    onchange={handleContactFormChange}
                    required="true"
                  >
                  </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2">
                  <lightning-input
                    name="lastName"
                    label="Last Name"
                    value={contactForm.lastName}
                    onchange={handleContactFormChange}
                    required="true"
                  >
                  </lightning-input>
                </div>
              </div>
              <div class="slds-grid slds-gutters slds-m-top_small">
                <div class="slds-col slds-size_1-of-2">
                  <lightning-input
                    name="email"
                    type="email"
                    label="Email"
                    value={contactForm.email}
                    onchange={handleContactFormChange}
                    required="true"
                  >
                  </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2">
                  <lightning-input
                    name="phone"
                    type="tel"
                    label="Phone"
                    value={contactForm.phone}
                    onchange={handleContactFormChange}
                  >
                  </lightning-input>
                </div>
              </div>
              <div class="slds-m-top_small">
                <lightning-input
                  name="company"
                  label="Company (Optional)"
                  value={contactForm.company}
                  onchange={handleContactFormChange}
                >
                </lightning-input>
              </div>
            </div>

            <!-- Shipping Address Form -->
            <div class="slds-m-bottom_medium">
              <h3 class="slds-text-heading_small slds-m-bottom_small">Shipping Address</h3>
              <div class="slds-m-bottom_small">
                <lightning-input
                  name="street"
                  label="Street Address"
                  value={shippingForm.street}
                  onchange={handleShippingFormChange}
                  required="true"
                >
                </lightning-input>
              </div>
              <div class="slds-grid slds-gutters">
                <div class="slds-col slds-size_1-of-3">
                  <lightning-input
                    name="city"
                    label="City"
                    value={shippingForm.city}
                    onchange={handleShippingFormChange}
                    required="true"
                  >
                  </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-3">
                  <lightning-input
                    name="state"
                    label="State/Province"
                    value={shippingForm.state}
                    onchange={handleShippingFormChange}
                    required="true"
                  >
                  </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-3">
                  <lightning-input
                    name="postalCode"
                    label="Postal Code"
                    value={shippingForm.postalCode}
                    onchange={handleShippingFormChange}
                    required="true"
                  >
                  </lightning-input>
                </div>
              </div>
              <div class="slds-m-top_small">
                <lightning-input
                  name="country"
                  label="Country"
                  value={shippingForm.country}
                  onchange={handleShippingFormChange}
                  required="true"
                >
                </lightning-input>
              </div>
            </div>

            <div class="slds-m-bottom_medium">
              <p class="slds-text-body_small slds-text-color_weak">
                By clicking "Place Order", you agree to our terms and conditions.
              </p>
            </div>
          </div>

          <!-- Modal Footer -->
          <footer class="slds-modal__footer">
            <lightning-button
              variant="neutral"
              label="Cancel"
              onclick={handleCloseCheckoutModal}
            >
            </lightning-button>

            <lightning-button
              variant="brand"
              label="Place Order"
              onclick={handleProcessCheckout}
              loading={checkoutLoading}
              disabled={isCheckoutFormValid}
            >
            </lightning-button>
          </footer>
        </div>
      </section>

      <!-- Modal Backdrop -->
      <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
  </lightning-card>
</template>
